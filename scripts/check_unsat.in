#!/usr/bin/env bash
: "${SAT_OPTIONS:= --quiet --unsat}"
bin="$(cd -- "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
limit="$bin"/limit
certifaiger="$bin"/certifaiger
sat_solver="$bin/@SAT@"
[ -n "@SAT_CHECKER@" ] && sat_checker="$bin/@SAT_CHECKER@"
echo "$(basename "$0"): Checking with SAT solver $(basename "$sat_solver") $SAT_OPTIONS"
[ -n "$sat_checker" ] && echo "$(basename "$0"): Checking proofs with $(basename "$sat_checker")"
aigtocnf="$bin"/aigtocnf
aigsplit="$bin"/aigsplit
for i in limit certifaiger sat_solver aigtocnf aigsplit; do
    [ ! -x "${!i}" ] && echo "$(basename "$0"): missing executable $i (${!i})" >&2 && exit 1
done
[ $# -lt 2 ] && echo "usage: $(basename "$0") <model> <witness>" && exit 0
mkdir -p ${TMPDIR:-/tmp}/froleyks-certifaiger
: ${SEQUENTIAL:=false}
TMP=$(mktemp -d "${TMPDIR:-/tmp}"/froleyks-certifaiger/$(basename "$0")-XXXXXXXX)

main_PID=$BASHPID
cleanup() {
    st=$?
    if [[ $BASHPID -eq $main_PID ]]; then
        rm -rf -- "$TMP"
    fi
    exit "$st"
}
trap cleanup EXIT HUP INT QUIT TERM

model="$1"
witness="$2"
check="${model##*/}"
check="${check%.*}"
check="${TMP}/check_${check}"
shift 2

for f in model witness; do
    path="${!f}"
    [ -f "$path" ] || {
        echo "$(basename "$0"): Error: missing file $path" >&2
        exit 1
    }
    echo "$(basename "$0"): $f $path $(wc -l <"$path") lines $(wc -c <"$path") bytes $(head -n 1 "$path")"
done

echo $(basename "$0"): Checking witness circuit "$witness"
$certifaiger "$model" "$witness" "$check".aig "$@"
certifaiger_exit=$?
[ $certifaiger_exit -ne 0 ] && echo "$(basename "$0"): Error: certifaiger failed with exit code $certifaiger_exit)" >&2 && exit 1
echo

cd "$TMP" || exit 1
$aigsplit -n "$check".aig split_ || {
    echo "$(basename "$0"): Error: aigsplit failed" >&2
    exit 1
}

sat() {
    echo Checking $1
    local t
    $aigtocnf "${TMP}/$2" "${TMP}/$2.cnf"
    [ -n "$sat_checker" ] && proof="${TMP}/$2.proof"
    [ "$(basename "$sat_checker")" = "lrat-trim" ] && format="--lrat --no-factor"
    $limit "$1" \
        $sat_solver $SAT_OPTIONS $format "${TMP}/$2.cnf" $proof >/dev/null
    if [ $? -ne 20 ]; then
        echo "Error: $1 check failed"
        exit 1
    fi
    if [ -n "$sat_checker" ]; then
        echo "$(basename "$0"): proof $proof $(wc -l <"$proof") lines $(wc -c <"$proof") bytes"
        expected=0
        [ "$(basename "$sat_checker")" = "lrat-trim" ] && expected=20 && quiet=--quiet
        $limit "check-$1" \
            $sat_checker $quiet "${TMP}/$2.cnf" $proof
        if [ $? -ne $expected ]; then
            echo "Error: $1 proof check failed"
            exit 1
        fi
    fi
    rm -f "$proof"
}

PIDS=()
t="$(date +%s%N)"
for aig in "$TMP"/*.aig; do
    [ "$aig" = "$check".aig ] && continue
    base="$(basename "$aig")"
    name="${base%.aig}"
    if $SEQUENTIAL; then
        sat "$name" "$base" || {
            echo $(basename "$0"): Certificate check failed.
            exit 1
        }
    else
        (sat "$name" "$base") &
        PIDS+=($!)
    fi
done
res=0
for pid in "${PIDS[@]}"; do
    wait "$pid" || res=1
done
t="$(($(date +%s%N) - t))"
t="$(printf '%d.%09d' "$((t / 1000000000))" "$((t % 1000000000))")"
echo "$(basename "$0"): t_total: $t"
[ $res -ne 0 ] && exit 1
echo "$(basename "$0"): Certificate check passed"
