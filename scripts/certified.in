#!/usr/bin/env bash
bin="$(cd -- "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
limit="$bin"/limit
check_sat="$bin"/check_sat
check_unsat="$bin"/check_unsat
for i in limit check_sat check_unsat; do
    [ ! -x "${!i}" ] && echo "$(basename "$0"): missing executable $i (${!i})" >&2 && exit 1
done
"$check_sat" >/dev/null || exit 1
"$check_unsat" >/dev/null || exit 1
[ $# -lt 2 ] && echo "usage: $(basename "$0") <model checker> <model> [<model checker args>]" && exit 0

mkdir -p ${TMPDIR:-/tmp}/froleyks-certifaiger
TMP=$(mktemp -d "${TMPDIR:-/tmp}"/froleyks-certifaiger/$(basename "$0")-XXXXXXXX)
trap 'st=$?; rm -rf -- "${TMP}"; exit "$st"' EXIT HUP INT QUIT TERM

MC="$1"
MODEL="$2"
shift 2
NAME=$(basename "$MODEL" | sed 's/\.[^.]*$//')
SAT=$TMP/${NAME}.sat
UNSAT=$TMP/${NAME}.unsat.aig
if [[ $# -ge 1 && $1 != -* ]]; then
    SAT="$1"
    UNSAT="$1"
    shift
fi
if [[ $# -ge 1 && $1 != -* ]]; then
    UNSAT="$1"
    shift
fi
echo $(basename "$0"): writing witness to "$SAT" and "$UNSAT"
LOG=$TMP/${NAME}.log

echo $(basename "$0"): running "$MC" on "$MODEL"
t="$(date +%s%N)"
$limit "$(basename $MC)" \
    $MC "$MODEL" "$SAT" "$UNSAT" "$@" | tee "$LOG"
res=${PIPESTATUS[0]}
t="$(($(date +%s%N) - t))"
t="$(printf '%d.%09d' "$((t / 1000000000))" "$((t % 1000000000))")"
echo $(basename "$0"): model checker exit code $res
if [ $res -eq 2 ]; then
    echo $(basename "$0"): model checker timeout
    exit 0
fi

if grep -q "^sat$" "$LOG"; then
    echo $(basename "$0"): Checking SAT
    "$check_sat" "$MODEL" "$SAT"
    res=$?
elif grep -q "^unsat$" "$LOG"; then
    echo $(basename "$0"): Checking UNSAT
    "$check_unsat" "$MODEL" "$UNSAT"
    res=$?
else
    echo $(basename "$0"): Model checker did not produce a recognizable result
    exit 1
fi
exit $res
